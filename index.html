<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Upload de Documentos - Prefeitura</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #f3f7fa; margin:0; }
  .container { max-width: 540px; margin: 32px auto 0 auto; background: #fff;
    border-radius: 12px; box-shadow: 0 1.5px 18px #17447e11; padding: 32px 3vw 32px 3vw; }
  h2 { color: #268437;margin-bottom:16px;}
  label { font-weight: 600; color: #20424A; }
  input[type="text"], select, input[type="file"] {
    padding: 8px 10px; margin: 3px 0 12px 0; border-radius: 6px; border: 1.3px solid #bcd9f8;
    font-size: 1em; width: 97%; max-width: 370px; background:#f8fbff; transition: border 0.15s;}
  input[type="text"]:focus, select:focus { border: 1.5px solid #43b67a; }
  .doc-upload { margin-bottom: 9px; border: 1px solid #e8ecee; padding: 10px 13px 16px 13px;
    border-radius: 9px; background: #fafff9;}
  .outros-input { display: none; margin: 4px 0 0 0; background:#f1fcf3;}
  .lista-anexos {margin-bottom: 15px;}
  .anexo-item {background: #e3fdea;border-radius:6px;display:flex;align-items:center;gap:8px;padding: 6px 10px 6px 10px;margin-top:7px;}
  .anexo-tipo {font-size:0.98em;font-weight:500; color:#287449;}
  .anexo-nome {font-family:monospace;font-size:0.95em;color:#222;}
  .anexo-remove {background:none;border:none;color:#cc3d2a;cursor:pointer;font-size:1em;padding:0;margin-left:auto;}
  .btn {
    display:inline-block;background: linear-gradient(90deg,#43b67a, #287c58);
    color: #fff;font-weight:bold;cursor:pointer;padding: 12px 28px; border-radius: 8px;
    font-size: 1.08em; margin-right:7px;margin-top:12px;border:none;box-shadow:0 1px 13px #0e703f13;
    transition:background .2s, box-shadow .18s;}
  .btn:hover { background: linear-gradient(90deg,#287c58, #43b67a);}
  .btn:disabled {opacity:.4;cursor:not-allowed;}
  .mensagem {
    margin-bottom: 19px;text-align: center; padding: 12px 0;
    border-radius: 8px; font-size:1.08em;font-weight:500; opacity: .97;
    border: 1.2px solid #11794a88; color:#137346; background: #d6ffe3;}
  .mensagem-erro {color:#b80622; background: #ffeaea; border:1.3px solid #e10320;}
  .mensagem-sucesso {color:#137346;background:#d6ffe3;border: 1.2px solid #11794a88;}
  .progresso { width: 98%; min-width:80px;height:10px;background: #e6f5eb; border-radius: 7px; margin-top: 4px;}
  .barra {height: 100%;background: #45c184;border-radius: 7px; width:0%;transition: width 0.2s;}
  @media (max-width:700px){.container{padding:10px 3vw 15px 3vw;}}
</style>
</head>
<body>
<div class="container">
  <h2>Enviar Documentos para Processo</h2>
  <div id="mensagem" class="mensagem" style="display:none"></div>
  <form id="uploadForm" autocomplete="off">
    <label for="processo">Nº do processo <span style="font-weight:400;">(123/2024, 1234/2024, ...)</span>:</label>
    <input type="text" id="processo" required pattern="^\d{3,5}/\d{4}$" autocomplete="off" placeholder="ex: 789/2024"><br>
    <label for="nomeRequerente">Seu nome:</label>
    <input type="text" id="nomeRequerente" required autocomplete="off" placeholder="Nome completo"><br>
    <div id="lista-anexos" class="lista-anexos"></div>
    <div id="docField"></div>
    <button type="button" class="btn" id="addOutroBtn">Adicionar outro documento</button>
    <button type="submit" class="btn" id="enviarBtn">Enviar</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDshXWDsFTqY_Ns-5_k060psGkhJlouRbI",
  authDomain: "rodilodocs.firebaseapp.com",
  projectId: "rodilodocs",
  storageBucket: "rodilodocs.firebasestorage.app",
  messagingSenderId: "530780718510",
  appId: "1:530780718510:web:8873bf4c55b52eb645743f",
  measurementId: "G-XLLX00DY7V"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
</script>
<script>
const MAX_SIZE = 10 * 1024 * 1024; // 10MB
const tipos = [
  "Projeto revisado","Id requerente","CAU/CREA profissionais","Documento de Propriedade",
  "Termos de Compromisso","Termo de Pequeno Gerador","Protocolo CBMERJ",
  "ART/RRT","IPTU","ISS ou comprovante","Boletos ou comprovantes",
  "Foto do Lotes","Contrato Social","Procuração","Outros"
];

let anexos = [];

function desenhaLista() {
  const listaDiv = document.getElementById("lista-anexos");
  if (anexos.length === 0) {
    listaDiv.innerHTML = "";
    document.getElementById("enviarBtn").disabled = true;
    return;
  }
  listaDiv.innerHTML = anexos.map((ax,i) => `
    <div class="anexo-item">
      <span class="anexo-tipo">${ax.tipo === "Outros" ? `Outros: ${ax.outros}` : ax.tipo}</span>
      <span class="anexo-nome">${ax.arquivo.name}</span>
      <button type="button" class="anexo-remove" onclick="removeAnexo(${i})" title="Remover">&#10060;</button>
    </div>
  `).join("");
  document.getElementById("enviarBtn").disabled = false;
}
window.removeAnexo = function(idx){
  anexos.splice(idx,1);
  desenhaLista();
};

function showMsg(msg, erro=false) {
  const m = document.getElementById("mensagem");
  m.innerHTML = msg;
  m.className = "mensagem" + (erro ? " mensagem-erro" : " mensagem-sucesso");
  m.style.display = "block";
}

function limparCampo(str) {
  // Remove acentos, espaços, caracteres especiais, deixa só letra, número, _ ou -
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
           .replace(/[^a-zA-Z0-9_-]/g, '');
}
function validarProcesso(val){
  return /^\d{3,5}\/\d{4}$/.test(val);
}

function resetDocField() {
  const docDiv = document.createElement("div");
  docDiv.className = "doc-upload";
  docDiv.innerHTML = `
    <label>Arquivo: <span style="font-size:0.98em;color:#888;font-weight:normal;">(máx: ${(MAX_SIZE/1024/1024)} MB)</span></label>
    <input type="file" id="fileInput" accept="*/*" required><br>
    <label>Tipo de documento:</label>
    <select id="tipoInput">
      <option value="">Selecione…</option>
      ${tipos.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('')}
    </select>
    <input class="outros-input" type="text" id="outrosInput" placeholder="Descreva (se Outros)" maxlength="40">
  `;
  document.getElementById("docField").innerHTML = "";
  document.getElementById("docField").appendChild(docDiv);
  docDiv.querySelector("#outrosInput").style.display = "none";
  docDiv.querySelector("#tipoInput").addEventListener("change", function(){
    docDiv.querySelector("#outrosInput").style.display = (this.value==="Outros")?"inline-block":"none";
  });
  docDiv.querySelector("#fileInput").addEventListener("change", function(){
    if (this.files[0] && this.files[0].size > MAX_SIZE) {
        showMsg(`Arquivo muito grande, máximo ${(MAX_SIZE/1024/1024).toFixed(1)}MB.`,true);
        this.value = "";
    }
  });
}
resetDocField();

document.getElementById("addOutroBtn").addEventListener("click", function(){
  // Pega dados do campo atual:
  const fileInput = document.getElementById("fileInput");
  const tipoInput = document.getElementById("tipoInput");
  const outrosInput = document.getElementById("outrosInput");

  if (!fileInput.files.length) {
    showMsg("Selecione um arquivo para anexar!", true);return;
  }
  if (!tipoInput.value) {
    showMsg("Selecione o tipo de documento!", true);return;
  }
  if (tipoInput.value === "Outros" && !outrosInput.value.trim()) {
    showMsg("Descreva o tipo se selecionou 'Outros'.", true);return;
  }
  if (fileInput.files[0].size > MAX_SIZE) {
    showMsg(`Arquivo muito grande, máximo ${(MAX_SIZE/1024/1024)}MB.`,true);return;
  }

  anexos.push({
    arquivo: fileInput.files[0],
    tipo: tipoInput.value,
    outros: tipoInput.value === "Outros" ? outrosInput.value : ""
  });
  desenhaLista();
  resetDocField();
  showMsg("Documento adicionado à lista. Você pode adicionar mais, ou enviar.", false);
});

document.getElementById("uploadForm").addEventListener("submit", async function(e){
  e.preventDefault();
  showMsg("",false);

  if (document.getElementById("fileInput").files.length > 0) {
    // Se tem um arquivo no campo principal, exija preencher tipo e outros, e adicione à lista antes do envio
    const fileInput = document.getElementById("fileInput");
    const tipoInput = document.getElementById("tipoInput");
    const outrosInput = document.getElementById("outrosInput");
    if (!tipoInput.value) { showMsg("Selecione o tipo de documento!", true); return;}
    if (tipoInput.value === "Outros" && !outrosInput.value.trim()) {
      showMsg("Descreva o tipo se selecionou 'Outros'!", true);return;
    }
    if (fileInput.files[0].size > MAX_SIZE) {
      showMsg(`Arquivo muito grande, máximo ${(MAX_SIZE/1024/1024)}MB.`,true);return;
    }
    anexos.push({
      arquivo: fileInput.files[0],
      tipo: tipoInput.value,
      outros: tipoInput.value === "Outros" ? outrosInput.value : ""
    });
    desenhaLista();
    resetDocField();
  }

  if (anexos.length === 0) {
    showMsg("Adicione ao menos um documento para anexar.", true); return;
  }
  const processo = document.getElementById("processo").value.trim();
  if (!validarProcesso(processo)) {
    showMsg("Número de processo inválido! Use o formato 1234/2024.",true); return;
  }
  const nome = document.getElementById("nomeRequerente").value.trim();
  if (!nome) { showMsg("Preencha seu nome.",true); return;}

  // Prepara partes do nome de arquivo
  let [numProc, anoProc] = processo.split("/");
  let procFinal = `${numProc}_${anoProc}`;
  let nomeLimpo = limparCampo(nome);

  // Bloqueia UI
  document.getElementById("addOutroBtn").disabled = true;
  document.getElementById("enviarBtn").disabled = true;

  // Lista e barras
  document.getElementById("lista-anexos").innerHTML = anexos.map((ax,i) =>
    `<div class="anexo-item">
      <span class="anexo-tipo">${ax.tipo==="Outros"?`Outros: ${ax.outros}`:ax.tipo}</span>
      <span class="anexo-nome">${ax.arquivo.name}</span>
      <div class="progresso" id="prog${i}"><div class="barra" id="barr${i}"></div></div>
    </div>`
  ).join("");

  // Faz upload um a um com caminho resumido raiz
  let ok = 0, erros = [];
  for(let i=0;i<anexos.length;i++){
    const ax = anexos[i];
    if(ax.arquivo.size > MAX_SIZE){
      erros.push(`${ax.arquivo.name}: Muito grande.`);
      continue;
    }
    let tipoLimpo = limparCampo(ax.tipo !== "Outros" ? ax.tipo : ax.outros);
    // Caminho resumido!
    const caminho = `${procFinal}-${tipoLimpo}-${nomeLimpo}_${ax.arquivo.name}`;
    const barra = document.getElementById("barr"+i);
    try{
      await new Promise((resolve,reject)=>{
        const uploadTask = storage.ref(caminho).put(ax.arquivo);
        uploadTask.on('state_changed', snap=>{
          barra.style.width = ((snap.bytesTransferred/snap.totalBytes)*100)+"%";
        },err=>{
          barra.style.background="#b80622";
          reject(err);
        },()=>{
          barra.style.background="#45c184";barra.style.width="100%";resolve();
        });
      });
      ok++;
    }catch(err){
      erros.push(`${ax.arquivo.name}: ${err.message}`);
    }
  }

  if(ok>0){
    showMsg(`Upload concluído! ${ok} arquivo(s) enviados com sucesso. ${erros.length?" Alguns não foram enviados: "+erros.join(" "):""}`,false);
    anexos = [];
    desenhaLista();
    resetDocField();
  }else{
    showMsg("Falha ao subir arquivos. "+(erros.length?erros.join(" "):""), true);
  }

  // Libera UI
  document.getElementById("addOutroBtn").disabled = false;
  document.getElementById("enviarBtn").disabled = false;
});
</script>
</body>
</html>